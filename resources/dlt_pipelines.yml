# Delta Live Tables Pipeline 定义
resources:
  pipelines:
    # ============ 主 Crime Data Pipeline ============
    chicago_crime_pipeline:
      name: "[${var.env}] Chicago Crime DLT Pipeline"
      
      catalog: ${var.catalog}
      target: ${var.schema}
      
      libraries:
        - notebook:
            path: ../src/notebooks/dlt_crime_pipeline.py
      
      configuration:
        env: ${var.env}
        storage_account: ${var.storage_account}
      
      continuous: false
      development: true
      channel: PREVIEW
      
      # ✅ 使用 Serverless - 删除 clusters 配置即可
      serverless: true

    # ============ Reference Data Pipeline ============
    reference_data_pipeline:
      name: "[${var.env}] Chicago Crime Reference Data DLT"
      
      catalog: ${var.catalog}
      target: ${var.schema}
      
      libraries:
        - notebook:
            path: ../src/notebooks/dlt_reference_data.py
      
      configuration:
        env: ${var.env}
        storage_account: ${var.storage_account}
      
      continuous: false
      development: true
      channel: PREVIEW
      
      # ✅ Serverless
      serverless: true

  # ============ 调度 Jobs ============
  jobs:
    scheduled_crime_pipeline:
      name: "[${var.env}] Scheduled Crime DLT Run"
      
      schedule:
        quartz_cron_expression: "0 0 */3 * * ?"  # ← 每 3 小时运行一次
        timezone_id: "America/Chicago"
        pause_status: UNPAUSED  # ← 改为 UNPAUSED 启用调度
      
      tasks:
        - task_key: refresh_reference_data
          pipeline_task:
            pipeline_id: ${resources.pipelines.reference_data_pipeline.id}
            full_refresh: false
        
        - task_key: run_crime_pipeline
          depends_on:
            - task_key: refresh_reference_data
          pipeline_task:
            pipeline_id: ${resources.pipelines.chicago_crime_pipeline.id}
            full_refresh: false